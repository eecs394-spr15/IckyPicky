<div ng-controller="IndexController">

  <super-navbar>
    <super-navbar-title>
      Index
    </super-navbar-title>
  </super-navbar>

  <canvas></canvas>
  <script>
    // http://paulirish.com/2011/requestanimationframe-for-smart-animating
    // shim layer with setTimeout fallback
  window.requestAnimFrame = (function(){
    return  window.requestAnimationFrame       || 
            window.webkitRequestAnimationFrame || 
            window.mozRequestAnimationFrame    || 
            window.oRequestAnimationFrame      || 
            window.msRequestAnimationFrame     || 
            function( callback ){
              window.setTimeout(callback, 1000 / 60);
            };
  })();

  var IckyPicky = {

    // set up some initial values
    WIDTH: 320, 
    HEIGHT:  480,
    scale:  1,
    offset: {top: 0, left: 0}, 
    hit: 0,
    score: 0,
    // we'll set the rest of these
    // in the init function
    RATIO:  null,
    currentWidth:  null,
    currentHeight:  null,
    canvas: null,
    ctx:  null,

    // variables for the face
    faceXPos: 10,
    faceYPos: 100,
    faceRate: 1,
    faceHeight: 250,
    faceWidth: 150,
    noseXOffset: 75,
    noseYOffset: 125,
    noseWidth: 15,
    noseHeight: 15,

    // varibles for the hand
    handPos: 400,
    handXOffset: 115,
    handRate: 5,
    fingerXOffset: 10,
    fingerYOffset: 15,
    fingerWidth: 15,
    fingerHeight: 15,

    nImages: 2,
    nLoadedImages: 0,
    handImg: new Image,
    faceImg: new Image,

    init: function() {

      // the proportion of width to height
      IckyPicky.RATIO = IckyPicky.WIDTH / IckyPicky.HEIGHT;
      // these will change when the screen is resized
      IckyPicky.currentWidth = IckyPicky.WIDTH;
      IckyPicky.currentHeight = IckyPicky.HEIGHT;
      // this is our canvas element
      IckyPicky.canvas = document.getElementsByTagName('canvas')[0];
      // setting this is important
      // otherwise the browser will
      // default to 320 x 200
      IckyPicky.canvas.width = IckyPicky.WIDTH;
      IckyPicky.canvas.height = IckyPicky.HEIGHT;
      // the canvas context enables us to 
      // interact with the canvas api
      IckyPicky.ctx = IckyPicky.canvas.getContext('2d');

      // load images
      IckyPicky.handImg.onload = function() {
        IckyPicky.nLoadedImages += 1;
        IckyPicky.maybeLoop();
      }
      IckyPicky.handImg.src = '/images/finger.png';

      IckyPicky.faceImg.onload = function() {
        IckyPicky.nLoadedImages += 1;
        IckyPicky.maybeLoop();
      }
      IckyPicky.faceImg.src = '/images/arisaface.jpg';

      // listen for clicks
      window.addEventListener('click', function(e) {
          e.preventDefault();
          IckyPicky.Input.set(e);
      }, false);

      // listen for touches
      window.addEventListener('touchstart', function(e) {
          e.preventDefault();
          // the event object has an array
          // called touches, we just want
          // the first touch
          IckyPicky.Input.set(e.touches[0]);
      }, false);
      window.addEventListener('touchmove', function(e) {
          // we're not interested in this
          // but prevent default behaviour
          // so the screen doesn't scroll
          // or zoom
          e.preventDefault();
      }, false);
      window.addEventListener('touchend', function(e) {
          // as above
          e.preventDefault();
      }, false);

      // we're ready to resize
      IckyPicky.resize();

      // it will then repeat continuously
      //IckyPicky.loop();
    },

    // this is where all entities will be moved
    // and checked for collisions, etc.
    update: function() {
      if ( (IckyPicky.faceXPos < 2 && !IckyPicky.hit) || (IckyPicky.faceXPos > IckyPicky.WIDTH - IckyPicky.faceWidth && !IckyPicky.hit)) {
        IckyPicky.faceRate = IckyPicky.faceRate * -1;
      }
      IckyPicky.faceXPos += IckyPicky.faceRate;


      var nose = {
        left: IckyPicky.noseXOffset + IckyPicky.faceXPos,
        right: IckyPicky.noseXOffset + IckyPicky.faceXPos + IckyPicky.noseWidth,
        top: IckyPicky.faceYPos + IckyPicky.noseYOffset,
        bottom: IckyPicky.faceYPos + IckyPicky.noseYOffset + IckyPicky.noseHeight
      };
      
      var finger = {
        left: IckyPicky.handXOffset - 10,
        right: IckyPicky.handXOffset - 10 + IckyPicky.fingerWidth,
        top: IckyPicky.handPos + 15,
        bottom: IckyPicky.handPos + 15 + IckyPicky.fingerHeight
      };

      IckyPicky.hit = IckyPicky.collides(nose, finger);

      if (IckyPicky.hit) {
        IckyPicky.handPos = 400;
        IckyPicky.hit = false;
        IckyPicky.Input.tapped = false;
        IckyPicky.score += 1;
      }

      if (IckyPicky.Input.tapped && IckyPicky.handPos > -155 && !IckyPicky.hit) {
          IckyPicky.handPos -= IckyPicky.handRate;
      }

      if(IckyPicky.handPos < -154) {
        IckyPicky.handPos = 400;
        IckyPicky.Input.tapped = false;
      }
    },

    // this is where we draw all the entities
    render: function() {
      IckyPicky.Draw.clear();
      IckyPicky.Draw.rect(0,IckyPicky.HEIGHT-45,IckyPicky.WIDTH,45, 'green');
      //IckyPicky.Draw.circle(IckyPicky.facePos, 100, 50, 'rgba(255,0,0,0.5)');
      IckyPicky.ctx.drawImage(IckyPicky.faceImg, IckyPicky.faceXPos, IckyPicky.faceYPos, IckyPicky.faceWidth, IckyPicky.faceHeight);
      
      IckyPicky.Draw.rect(IckyPicky.faceXPos + IckyPicky.noseXOffset, IckyPicky.faceYPos + IckyPicky.noseYOffset, 5, 5, 'green');
      IckyPicky.ctx.drawImage(IckyPicky.handImg, IckyPicky.handXOffset, IckyPicky.handPos, 70, 150);
      
      IckyPicky.Draw.rect(IckyPicky.handXOffset - IckyPicky.fingerXOffset, IckyPicky.handPos + IckyPicky.fingerYOffset, 5, 5, 'green');
      IckyPicky.Draw.text('score: ' + IckyPicky.score.toString(), 20, 20, 10, '#000');

      //IckyPicky.Draw.text('Hello World', 100, 100, 10, '#000');
      //IckyPicky.Draw.circle(IckyPicky.Width/2, IckyPicky.HEIGHT/2, 100, 'red');
    },

    maybeLoop: function() {
      if (IckyPicky.nLoadedImages == IckyPicky.nImages) {
        IckyPicky.loop();
      }
    },

    // the game loop
    loop: function() {
      requestAnimFrame( IckyPicky.loop );

      IckyPicky.update();
      IckyPicky.render();
    },

    resize: function() {

      IckyPicky.currentHeight = window.innerHeight;
      // resize the width in proportion
      // to the new height
      IckyPicky.currentWidth = IckyPicky.currentHeight * IckyPicky.RATIO;

      // this will create some extra space on the
      // page, allowing us to scroll past
      // the address bar, thus hiding it.
      if (IckyPicky.android || IckyPicky.ios) {
        //document.body.style.height = (window.innerHeight + 50) + 'px';
      }

      // set the new canvas style width and height
      // note: our canvas is still 320 x 480, but
      // we're essentially scaling it with CSS
      IckyPicky.canvas.style.width = IckyPicky.currentWidth + 'px';
      IckyPicky.canvas.style.height = IckyPicky.currentHeight + 'px';

      // we use a timeout here because some mobile
      // browsers don't fire if there is not
      // a short delay
      window.setTimeout(function() {
        window.scrollTo(0,1);
      }, 1);
    }
  };

	window.addEventListener('load', IckyPicky.init, false);
	window.addEventListener('resize', IckyPicky.resize, false);

	// we need to sniff out Android and iOS
	// so that we can hide the address bar in
	// our resize function
	IckyPicky.ua = navigator.userAgent.toLowerCase();
	IckyPicky.android = IckyPicky.ua.indexOf('android') > -1 ? true : false;
	IckyPicky.ios = ( IckyPicky.ua.indexOf('iphone') > -1 || IckyPicky.ua.indexOf('ipad') > -1  ) ? 
	    true : false;

  	// abstracts various canvas operations
	IckyPicky.Draw = {

    clear: function() {
      IckyPicky.ctx.clearRect(0, 0, IckyPicky.WIDTH, IckyPicky.HEIGHT);
    },

    rect: function(x, y, w, h, col) {
      IckyPicky.ctx.fillStyle = col;
      IckyPicky.ctx.fillRect(x, y, w, h);
    },

    circle: function(x, y, r, col) {
      IckyPicky.ctx.fillStyle = col;
      IckyPicky.ctx.beginPath();
      IckyPicky.ctx.arc(x + 5, y + 5, r, 0,  Math.PI * 2, true);
      IckyPicky.ctx.closePath();
      IckyPicky.ctx.fill();
    },

    text: function(string, x, y, size, col) {
      IckyPicky.ctx.font = 'bold '+size+'px Monospace';
      IckyPicky.ctx.fillStyle = col;
      IckyPicky.ctx.fillText(string, x, y);
    }
	};

  IckyPicky.Input = {

    x: 0,
    y: 0,
    tapped :false,

    set: function(data) {
        this.x = (data.pageX - IckyPicky.offset.left) / IckyPicky.scale;
        this.y = (data.pageY - IckyPicky.offset.top) / IckyPicky.scale;
        this.tapped = true;
    }
  };


  IckyPicky.collides = function(r1, r2) {

          return !(r2.left > r1.right || 
            r2.right < r1.left || 
            r2.top > r1.bottom ||
            r2.bottom < r1.top);

  };
//steroids.view.setBackgroundImage("/img/space-background.png");

</script>

</div>